<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>Cartes d‚Äôapprentissage (offline)</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#0b1020; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --good:#22c55e; --bad:#ef4444; --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 20% 0%, #172554 0%, var(--bg) 45%) fixed;
      color:var(--text);
    }
    header{position:sticky; top:0; z-index:5; background: rgba(11,16,32,.75); backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148,163,184,.15);}
    .wrap{max-width: 900px; margin: 0 auto; padding: 14px 16px;}
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{font-size: 16px; margin:0; font-weight:650}
    .pill{display:inline-flex; gap:8px; align-items:center; color:var(--muted); font-size: 12.5px}
    .pill b{color:var(--text); font-weight:650}
    main .wrap{padding-top: 18px; padding-bottom: 28px;}
    .panel{background: rgba(17,24,39,.85); border:1px solid rgba(148,163,184,.14);
      border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden;}
    .panelHead{padding: 14px 14px 0 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    select{
      background: rgba(31,41,55,.85); color: var(--text); border:1px solid rgba(148,163,184,.20);
      border-radius: 12px; padding: 10px 12px; font-size: 14px; outline:none; min-width: 240px;
    }
    .btn{
      background: rgba(31,41,55,.85); color: var(--text); border:1px solid rgba(148,163,184,.20);
      border-radius: 12px; padding: 10px 12px; font-size: 14px; cursor:pointer;
      transition: transform .02s ease, background .15s ease, border-color .15s ease; user-select:none;
    }
    .btn:hover{background: rgba(39,52,73,.92); border-color: rgba(148,163,184,.28);}
    .btn:active{transform: translateY(1px);}
    .btn.good{border-color: rgba(34,197,94,.45);}
    .btn.bad{border-color: rgba(239,68,68,.45);}
    .btn.primary{background: rgba(30,64,175,.85); border-color: rgba(59,130,246,.55);}
    .btn.primary:hover{background: rgba(30,64,175,.95);}
    .grid{display:grid; grid-template-columns: 1fr; gap: 14px; padding: 14px;}
    .card{
      background: rgba(17,24,39,.92); border:1px solid rgba(148,163,184,.14); border-radius: var(--radius);
      padding: 18px; box-shadow: var(--shadow); min-height: 260px; display:flex; flex-direction:column;
      justify-content:space-between;
    }
    .label{color:var(--muted); font-size: 12px; letter-spacing:.2px}
    .q{font-size: 22px; line-height: 1.25; margin: 8px 0 0 0; font-weight:700}
    .a{margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(148,163,184,.15);
      font-size: 16px; line-height: 1.45; white-space: pre-wrap;}
    .hidden{display:none !important;}
    .footerBar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; padding: 0 14px 14px 14px;}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .stats{color: var(--muted); font-size: 13px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .toast{
      position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px;
      background: rgba(17,24,39,.92); border: 1px solid rgba(148,163,184,.18); border-radius: 14px;
      padding: 10px 12px; color: var(--text); box-shadow: var(--shadow); font-size: 13px;
      opacity:0; pointer-events:none; transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px);}
    .small{font-size: 12px; color: var(--muted);}
  
    .img{
      width: 100%;
      max-width: 100%;
      height: auto;
      margin-top: 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <h1>Cartes d‚Äôapprentissage</h1>
        <div class="pill">Offline : <b id="offlineLabel">pr√©paration‚Ä¶</b></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="pill">Th√®me : <b id="themeName">‚Äî</b></div>
        <div class="pill">Progression : <b id="progressLabel">‚Äî</b></div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="panel">
        <div class="panelHead">
          <select id="themeSelect" aria-label="Choisir un th√®me"></select>
          <button class="btn" id="shuffleBtn">üîÄ M√©langer</button>
          <button class="btn" id="wrongOnlyBtn">üîÅ Revoir les faux</button>
          <button class="btn" id="resetBtn">‚ôªÔ∏è R√©initialiser stats</button>
        </div>

        <div class="grid">
          <div class="card">
            <div>
              <div class="label" id="cardMeta">Question</div>
              <div class="q" id="qText">Chargement‚Ä¶</div>
                            <img id="qImg" class="img hidden" alt="Illustration question" />
<div class="a hidden" id="aText"></div>
                          <img id="aImg" class="img hidden" alt="Illustration r√©ponse" />
</div>

            <div class="footerBar">
              <div class="actions">
                <button class="btn primary" id="showAnswerBtn">üëÅ Voir la r√©ponse</button>
                                <button class="btn" id="skipBtn">‚è≠ Plus tard</button>
<button class="btn good hidden" id="justeBtn">‚úÖ Juste</button>
                <button class="btn bad hidden" id="fauxBtn">‚ùå Faux</button>
              </div>
              <div class="stats" id="statsLine">‚Äî</div>
            </div>
          </div>

          <div class="small" style="padding: 0 14px 14px 14px;">
            iPhone : Safari ‚Üí <b>Partager</b> ‚Üí <b>Ajouter √† l‚Äô√©cran d‚Äôaccueil</b>.
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const themeSelect = $("themeSelect");
  const shuffleBtn = $("shuffleBtn");
  const wrongOnlyBtn = $("wrongOnlyBtn");
  const resetBtn = $("resetBtn");

  const qText = $("qText");
  const aText = $("aText");
  const qImg = $("qImg");
  const aImg = $("aImg");
  const showAnswerBtn = $("showAnswerBtn");
  const justeBtn = $("justeBtn");
  const fauxBtn = $("fauxBtn");

  
  const skipBtn = $("skipBtn");
const themeName = $("themeName");
  const progressLabel = $("progressLabel");
  const statsLine = $("statsLine");
  const offlineLabel = $("offlineLabel");
  const cardMeta = $("cardMeta");

  const toast = $("toast");

  const STORAGE_KEY = "flashcards_stats_v1";
  let THEMES_INDEX = null;
  let THEME = null;

  let state = { themeId: null, order: [], index: 0, showAnswer: false, reviewWrongOnly: false };

  function notify(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 1300);
  }

  function loadStats(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveStats(stats){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
  }

  function getThemeStats(stats){
    if(!stats[state.themeId]) stats[state.themeId] = { correct: {}, wrong: {}, seen: {} };
    return stats[state.themeId];
  }

  function currentCard(){
    const cardId = state.order[state.index];
    return THEME.cards.find(c=>c.id===cardId);
  }

  function buildOrder(){
    const stats = loadStats();
    const tStats = getThemeStats(stats);
    let ids = THEME.cards.map(c=>c.id);

    if(state.reviewWrongOnly){
      const wrongIds = Object.keys(tStats.wrong || {}).filter(k => tStats.wrong[k] > 0);
      ids = wrongIds.length ? wrongIds : ids;
      if(!wrongIds.length){ notify("Aucun faux enregistr√© ‚Äî mode normal."); state.reviewWrongOnly = false; }
    }

    for(let i=ids.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [ids[i], ids[j]] = [ids[j], ids[i]];
    }
    state.order = ids;
    state.index = 0;
    state.showAnswer = false;
    render();
  }

  function render(){
    const stats = loadStats();
    const tStats = getThemeStats(stats);
    const card = currentCard();

    themeName.textContent = THEME.name;

    aText.classList.toggle("hidden", !state.showAnswer);
    showAnswerBtn.classList.toggle("hidden", state.showAnswer);
    justeBtn.classList.toggle("hidden", !state.showAnswer);
    fauxBtn.classList.toggle("hidden", !state.showAnswer);

    qText.textContent = card.q;
    aText.textContent = card.a;

    
    // Images optionnelles (si pr√©sentes dans le JSON)
    if (card.img) {
      qImg.src = card.img;
      qImg.classList.remove("hidden");
    } else {
      qImg.removeAttribute("src");
      qImg.classList.add("hidden");
    }

    if (state.showAnswer && card.img_answer) {
      aImg.src = card.img_answer;
      aImg.classList.remove("hidden");
    } else {
      aImg.removeAttribute("src");
      aImg.classList.add("hidden");
    }
const n = state.order.length;
    progressLabel.textContent = (state.index+1) + " / " + n + (state.reviewWrongOnly ? " (faux)" : "");
    cardMeta.textContent = "Question ‚Ä¢ " + card.id;

    const seenCount = Object.keys(tStats.seen || {}).length;
    const correctCount = Object.keys(tStats.correct || {}).length;
    const wrongCount = Object.keys(tStats.wrong || {}).length;
    const total = THEME.cards.length;
    statsLine.innerHTML = `Vues: <b>${seenCount}/${total}</b> ‚Ä¢ Juste: <b>${correctCount}</b> ‚Ä¢ Faux: <b>${wrongCount}</b>`;
  }

  function nextCard(){
    state.showAnswer = false;
    if(state.index < state.order.length - 1){
      state.index += 1;
    } else {
      notify("Fin de s√©rie ‚Äî m√©lang√© !");
      buildOrder();
      return;
    }
    render();
  }

  function mark(isCorrect){
    const stats = loadStats();
    const tStats = getThemeStats(stats);
    const card = currentCard();

    tStats.seen[card.id] = 1;
    if(isCorrect){
      tStats.correct[card.id] = 1;
      delete tStats.wrong[card.id];
      notify("‚úÖ Not√© juste");
    } else {
      tStats.wrong[card.id] = (tStats.wrong[card.id] || 0) + 1;
      delete tStats.correct[card.id];
      notify("‚ùå Not√© faux");
    }
    saveStats(stats);
    nextCard();
  }

  async function loadTheme(themeId){
    const meta = THEMES_INDEX.themes.find(t=>t.id===themeId);
    if(!meta) throw new Error("Th√®me introuvable: " + themeId);
    const theme = await fetch(meta.file, { cache: "no-store" }).then(r=>r.json());
    THEME = theme;
    state.themeId = themeId;
    state.reviewWrongOnly = false;
    buildOrder();
  }

  // Events
  showAnswerBtn.addEventListener("click", ()=>{ state.showAnswer = true; render();   skipBtn.addEventListener("click", ()=>{
    // Met la carte actuelle √† la fin de la s√©rie pour y r√©pondre plus tard
    if(!state.order.length) return;
    if(state.index >= state.order.length - 1){
      notify("D√©j√† la derni√®re carte");
      return;
    }
    const cardId = state.order[state.index];
    state.order.splice(state.index, 1);
    state.order.push(cardId);
    state.showAnswer = false;
    notify("Mis √† la fin");
    render();
  });
});
  justeBtn.addEventListener("click", ()=>mark(true));
  fauxBtn.addEventListener("click", ()=>mark(false));
  shuffleBtn.addEventListener("click", ()=>{ notify("M√©lang√©"); buildOrder(); });
  wrongOnlyBtn.addEventListener("click", ()=>{ state.reviewWrongOnly = !state.reviewWrongOnly; notify(state.reviewWrongOnly ? "Mode: faux uniquement" : "Mode: normal"); buildOrder(); });
  resetBtn.addEventListener("click", ()=>{ if(!confirm("R√©initialiser les statistiques pour tous les th√®mes ?")) return; localStorage.removeItem(STORAGE_KEY); notify("Stats r√©initialis√©es"); buildOrder(); });
  themeSelect.addEventListener("change", async ()=>{ await loadTheme(themeSelect.value); });

  // Load index
  fetch("themes/index.json", { cache: "no-store" })
    .then(r=>r.json())
    .then(async (idx)=>{
      THEMES_INDEX = idx;
      themeSelect.innerHTML = idx.themes.map(t=>`<option value="${t.id}">${t.name}</option>`).join("");
      await loadTheme(idx.themes[0].id);
      offlineLabel.textContent = "ok";
    })
    .catch(err=>{
      console.error(err);
      qText.textContent = "Erreur de chargement (themes/index.json).";
      offlineLabel.textContent = "erreur";
    });

  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js").then(()=>{
      offlineLabel.textContent = "ok";
    }).catch(()=>{
      // ignore
    });
  }
})();
</script>
</body>
</html>
