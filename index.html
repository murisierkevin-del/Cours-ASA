<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cours ASA ‚Äì R√©vision</title>

  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png?v=10">
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png?v=10">
  <link rel="apple-touch-icon" href="./icon-192.png?v=10">
  <link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png?v=10">

  <style>
    :root{
      --bg:#0f1220; --card:#171a2b; --txt:#e9ecff; --muted:#9aa3ff;
      --good:#2ecc71; --bad:#ff6b6b; --primary:#5b7cff; --panel:#121826;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --gold:#f5b942;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0;}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      background:linear-gradient(180deg,#0b0e1a,#0f1220);
      color:var(--txt);
      overflow:hidden;
    }

    .app{
      height:100dvh;
      display:flex;
      flex-direction:column;
      padding:12px 12px 0 12px;
    }
    @supports (-webkit-touch-callout:none){
      .app{ height:-webkit-fill-available; }
    }

    .topbar{
      position:sticky; top:0;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:10px;
      padding-bottom:8px;
      z-index:10;
      backdrop-filter: blur(10px);
    }
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--txt);
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }
    .pill.muted{ color:var(--muted); font-weight:700; }
    .btn{
      background:rgba(255,255,255,.06);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      touch-action:manipulation;
    }
    .btn:active{ transform:scale(.99); }
    select{
      background:#0b0e1a;
      color:var(--txt);
      border-radius:14px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.15);
      font-weight:800;
      font-size:13px;
      max-width: 100%;
    }

    main{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom: calc(190px + env(safe-area-inset-bottom));
    }

    .card{
      background:var(--card);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .q{font-size:1.25rem; font-weight:900; margin:0 0 10px 0; line-height:1.25}
    .a{white-space:pre-wrap; margin-top:10px; color:rgba(233,236,255,.92); line-height:1.35}
    .img{width:100%; height:auto; border-radius:14px; margin-top:12px; box-shadow:var(--shadow)}

    .panel{
      position:fixed;
      left:0; right:0; bottom:0;
      background:var(--panel);
      padding:12px 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      border-top-left-radius:22px;
      border-top-right-radius:22px;
      box-shadow:0 -10px 30px rgba(0,0,0,.45);
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:20;
    }
    .row{display:flex; gap:10px;}

    .actionBtn{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      touch-action:manipulation;
      color:#fff;
      background:rgba(255,255,255,.10);
      width:100%;
    }
    .actionBtn:active{ transform:scale(.99); }
    button:disabled{ opacity:.45; filter:saturate(.7); }

    .primary{background:var(--primary);}
    .good{background:var(--good); color:#052;}
    .bad{background:var(--bad);}
    .gold{background:var(--gold); color:#1b1b1b;}

    .statsLine{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:.9rem;
      justify-content:space-between;
    }

    .hidden{ display:none !important; }

    /* üîÅ Swap ‚ÄúVoir la r√©ponse‚Äù ‚Üî ‚ÄúJuste‚Äù (m√™me place) */
    .swapWrap{
      position: relative;
      width: 100%;
      height: 48px; /* hauteur stable (√©vite le jump) */
    }
    .swapBtn{
      position: absolute;
      inset: 0;
      width: 100%;
      transition: opacity .16s ease, transform .16s ease;
      will-change: opacity, transform;
    }
    /* IMPORTANT: doit battre button:disabled sur iPhone/Safari */
    .swapHide{
      opacity: 0 !important;
      transform: translateY(6px);
      pointer-events: none !important;
    }

    @media (min-width: 900px){
      body{ overflow:auto; }
      .app{ max-width: 1200px; margin:0 auto; height:auto; padding:16px; }
      main{ padding-bottom: 0; }
      .panel{ position:static; border-radius:18px; margin-top:14px; }
      .swapWrap{ height:auto; } /* desktop */
      .swapBtn{ position:static; } /* desktop */
      .swapHide{ display:none; } /* desktop */
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <select id="themeSelect"></select>

      <span class="pill muted">Version contenu: <span id="contentVersion">‚Äî</span></span>
      <span class="pill muted">R√©seau: <span id="offlineLabel">‚Äî</span></span>

      <!-- ‚úÖ demand√© : on supprime M√©langer + Revoir les faux -->
      <button class="btn" id="resetStatsBtn" title="R√©initialiser la progression (toutes les questions reviennent)">‚ôªÔ∏è R√©initialiser stats</button>
    </div>

    <main>
      <div class="card">
        <div class="q" id="qText">‚Äî</div>
        <img id="qImg" class="img hidden" alt="" />

        <div class="a hidden" id="aText"></div>
        <img id="aImg" class="img hidden" alt="" />
      </div>
    </main>

    <div class="panel">
      <div class="statsLine">
        <div id="statsLine">‚Äî</div>
      </div>

      <!-- ‚úÖ Swap: m√™me place -->
      <div class="row">
        <div class="swapWrap">
          <button class="actionBtn primary swapBtn" id="showAnswerBtn">üëÅ Voir la r√©ponse</button>
          <button class="actionBtn good swapBtn swapHide" id="justeBtn" disabled>‚úÖ Juste</button>
        </div>
      </div>

      <!-- Suivant -->
      <div class="row" id="skipRow">
        <button class="actionBtn" id="skipBtn" title="Passer (question remise dans le tirage al√©atoire)">‚è≠ Suivant</button>
      </div>

      <!-- Faux en bas -->
      <div class="row hidden" id="fauxRow">
        <button class="actionBtn bad" id="fauxBtn" disabled>‚ùå Faux</button>
      </div>

      <button class="actionBtn gold hidden" id="finishBtn">üéâ Th√®me termin√© ‚Äì changer de th√®me</button>
    </div>
  </div>

<script>
/*
  ‚úÖ Modifs demand√©es :
  - Supprime ‚ÄúM√©langer‚Äù ‚Üí tirage al√©atoire automatique
  - Supprime ‚ÄúRevoir les faux‚Äù + sa logique
  - R√©vision intelligente : apr√®s 3x ‚ÄúJuste‚Äù, la question dispara√Æt
  - Stat progression en % (ma√Ætris√©es / total)
  - ‚ÄúR√©initialiser stats‚Äù : remet TOUTES les questions (reset des compteurs)
*/

const $ = (id)=>document.getElementById(id);

const themeSelect = $("themeSelect");
const offlineLabel = $("offlineLabel");
const contentVersion = $("contentVersion");

const qText = $("qText");
const aText = $("aText");
const qImg = $("qImg");
const aImg = $("aImg");

const showAnswerBtn = $("showAnswerBtn");
const justeBtn = $("justeBtn");
const fauxBtn = $("fauxBtn");
const fauxRow = $("fauxRow");

const skipBtn = $("skipBtn");
const skipRow = $("skipRow");
const finishBtn = $("finishBtn");

const statsLine = $("statsLine");
const resetStatsBtn = $("resetStatsBtn");

let THEMES_INDEX = null;
let appVersion = "0"; // from themes/index.json version

let fullCards = [];       // toutes les cartes du th√®me
let activeCards = [];     // cartes √† r√©viser (ma√Ætrise < 3)
let currentCard = null;

let state = { showAnswer:false };
let currentThemeId = null;

const MASTERY_THRESHOLD = 3;
let mastery = {};         // { [id]: number } 0..3

function setOfflineLabel(ok){ offlineLabel.textContent = ok ? "ok" : "erreur"; }

/* ‚úÖ Mini ligne r√©seau fiable (online/offline + ping l√©ger) */
function refreshNetworkLabel(){
  setOfflineLabel(navigator.onLine);
  fetch("themes/index.json", { cache:"no-store" })
    .then(r => setOfflineLabel(r.ok))
    .catch(() => setOfflineLabel(false));
}
window.addEventListener("online", refreshNetworkLabel);
window.addEventListener("offline", refreshNetworkLabel);
setInterval(refreshNetworkLabel, 15000);

function withBust(url){
  return url + (url.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(appVersion);
}

function storageKeyMastery(themeId){ return `asa_mastery_${themeId}`; }

function loadMastery(themeId){
  try{
    const raw = localStorage.getItem(storageKeyMastery(themeId));
    const obj = raw ? JSON.parse(raw) : {};
    mastery = (obj && typeof obj === "object") ? obj : {};
  }catch(_){
    mastery = {};
  }
}
function saveMastery(){
  if(!currentThemeId) return;
  localStorage.setItem(storageKeyMastery(currentThemeId), JSON.stringify(mastery));
}

function ensureIds(arr){
  // au cas o√π une carte n‚Äôa pas d‚Äôid ‚Üí id stable par index
  return arr.map((c, i) => {
    if(!c || typeof c !== "object") return { id:`auto_${i}`, q:"", a:"" };
    if(!c.id) c.id = `auto_${i}`;
    return c;
  });
}

function computeActiveCards(){
  return fullCards.filter(c => (mastery[c.id] || 0) < MASTERY_THRESHOLD);
}

function masteredCount(){
  let n = 0;
  for(const c of fullCards){
    if((mastery[c.id] || 0) >= MASTERY_THRESHOLD) n++;
  }
  return n;
}

function pickRandomCard(){
  if(!activeCards.length){
    currentCard = null;
    return;
  }
  const idx = Math.floor(Math.random() * activeCards.length);
  currentCard = activeCards[idx];
}

function lockMarkButtons(locked){
  justeBtn.disabled = locked;
  fauxBtn.disabled = locked;
}

function isThemeFinished(){
  return fullCards.length > 0 && activeCards.length === 0;
}

function updateStatsLine(){
  const total = fullCards.length;
  const done = masteredCount();
  const pct = total ? Math.round((done / total) * 100) : 0;
  const rest = activeCards.length;
  statsLine.textContent = `${done}/${total} ‚Ä¢ ${pct}% ‚Ä¢ Reste: ${rest}`;
}

function render(){
  if(isThemeFinished()){
    qText.textContent = "‚úÖ Th√®me termin√© !";
    aText.classList.add("hidden"); aText.textContent = "";
    qImg.classList.add("hidden"); qImg.removeAttribute("src");
    aImg.classList.add("hidden"); aImg.removeAttribute("src");

    finishBtn.classList.remove("hidden");

    showAnswerBtn.classList.add("hidden");
    justeBtn.classList.add("hidden");
    fauxRow.classList.add("hidden");
    skipRow.classList.add("hidden");

    // stats final
    const total = fullCards.length;
    const done = masteredCount();
    const pct = total ? Math.round((done / total) * 100) : 0;
    statsLine.textContent = `${done}/${total} ‚Ä¢ ${pct}% (termin√©)`;
    return;
  } else {
    finishBtn.classList.add("hidden");
    showAnswerBtn.classList.remove("hidden");
    justeBtn.classList.remove("hidden");
    skipRow.classList.remove("hidden");
  }

  if(!fullCards.length){
    qText.textContent="Aucune carte.";
    aText.textContent=""; aText.classList.add("hidden");
    qImg.classList.add("hidden"); qImg.removeAttribute("src");
    aImg.classList.add("hidden"); aImg.removeAttribute("src");

    fauxRow.classList.add("hidden");
    skipRow.classList.remove("hidden");

    showAnswerBtn.classList.remove("swapHide");
    justeBtn.classList.add("swapHide");

    statsLine.textContent="‚Äî";
    lockMarkButtons(true);
    return;
  }

  if(!currentCard){
    pickRandomCard();
  }
  const card = currentCard;

  qText.textContent = card.q || "";

  if(card.img){
    qImg.src = card.img;
    qImg.classList.remove("hidden");
  }else{
    qImg.classList.add("hidden");
    qImg.removeAttribute("src");
  }

  if(state.showAnswer && card.a && card.a.trim()!==""){
    aText.textContent = card.a;
    aText.classList.remove("hidden");
  }else{
    aText.textContent = "";
    aText.classList.add("hidden");
  }

  if(state.showAnswer && card.img_answer){
    aImg.src = card.img_answer;
    aImg.classList.remove("hidden");
  }else{
    aImg.classList.add("hidden");
    aImg.removeAttribute("src");
  }

  // Swap + UX pouce
  showAnswerBtn.classList.toggle("swapHide", state.showAnswer);
  justeBtn.classList.toggle("swapHide", !state.showAnswer);

  skipRow.classList.toggle("hidden", state.showAnswer);
  fauxRow.classList.toggle("hidden", !state.showAnswer);

  lockMarkButtons(!state.showAnswer);

  updateStatsLine();
}

function nextRandom(){
  state.showAnswer = false;
  pickRandomCard();
  render();
}

showAnswerBtn.addEventListener("click", ()=>{
  state.showAnswer = true;
  render();
});

skipBtn.addEventListener("click", ()=>{
  // al√©atoire automatique : on repioche juste
  nextRandom();
});

justeBtn.addEventListener("click", ()=>{
  if(!state.showAnswer) return;
  const c = currentCard;
  if(!c) return;

  const v = (mastery[c.id] || 0) + 1;
  mastery[c.id] = Math.min(MASTERY_THRESHOLD, v);
  saveMastery();

  // recalcul des cartes actives : si atteint 3, elle dispara√Æt
  activeCards = computeActiveCards();

  // pioche suivante
  currentCard = null;
  nextRandom();
});

fauxBtn.addEventListener("click", ()=>{
  if(!state.showAnswer) return;
  const c = currentCard;
  if(!c) return;

  // logique simple : si faux, on remet la ma√Ætrise √† 0 (√ßa revient plus souvent)
  mastery[c.id] = 0;
  saveMastery();

  activeCards = computeActiveCards();
  currentCard = null;
  nextRandom();
});

resetStatsBtn.addEventListener("click", ()=>{
  if(!currentThemeId) return;
  if(confirm("R√©initialiser la progression de ce th√®me ? (Toutes les questions reviennent)")){
    mastery = {};
    saveMastery();

    activeCards = computeActiveCards();
    currentCard = null;
    state.showAnswer = false;

    render();
  }
});

finishBtn.addEventListener("click", ()=>{
  window.scrollTo({ top: 0, left: 0, behavior: "smooth" });
  setTimeout(()=>{
    themeSelect.focus();
    alert("Th√®me termin√© ‚úÖ\nChoisis un autre th√®me en haut.");
  }, 250);
});

themeSelect.addEventListener("change", e=>loadTheme(e.target.value));

async function loadTheme(id){
  const t = THEMES_INDEX?.themes?.find(x=>x.id===id);
  if(!t){
    fullCards=[]; activeCards=[]; currentThemeId=null; currentCard=null;
    qText.textContent="Th√®me introuvable.";
    render();
    return;
  }

  currentThemeId = id;
  state.showAnswer = false;
  currentCard = null;

  loadMastery(id);

  try{
    const r = await fetch(withBust(t.file), {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const data = await r.json();
    if(!Array.isArray(data.cards)) throw new Error("JSON invalide: cards manquant");

    fullCards = ensureIds(data.cards.slice());
    activeCards = computeActiveCards();

    render();
    setOfflineLabel(true);
  }catch(e){
    fullCards=[]; activeCards=[]; currentCard=null; state.showAnswer=false;
    qText.textContent = `Erreur de chargement du th√®me: ${t.file}`;
    aText.textContent = String(e);
    aText.classList.remove("hidden");
    statsLine.textContent="‚Äî";
    setOfflineLabel(false);
  }
}

async function loadIndex(){
  try{
    const r = await fetch("themes/index.json", {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const idx = await r.json();
    if(!Array.isArray(idx.themes) || idx.themes.length===0) throw new Error("index.json invalide (themes vide)");
    if(!idx.version) throw new Error("index.json: champ 'version' manquant");

    THEMES_INDEX = idx;

    contentVersion.textContent = idx.version;
    appVersion = idx.version;

    themeSelect.innerHTML = idx.themes.map(t=>`<option value="${t.id}">${t.name}</option>`).join("");
    await loadTheme(idx.themes[0].id);

    refreshNetworkLabel();

    if("serviceWorker" in navigator){
      navigator.serviceWorker.register(withBust("sw.js")).catch(()=>{});
    }
  }catch(err){
    console.error(err);
    setOfflineLabel(false);
    contentVersion.textContent = "ERREUR index.json";
    qText.textContent="Erreur de chargement (themes/index.json).";
    aText.textContent=String(err);
    aText.classList.remove("hidden");

    showAnswerBtn.classList.add("hidden");
    justeBtn.classList.add("hidden");
    fauxRow.classList.add("hidden");
    skipRow.classList.add("hidden");
    finishBtn.classList.add("hidden");
  }
}

loadIndex();
</script>
</body>
</html>
